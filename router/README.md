# Router
В качестве обратного прокси использован Traefik. Обратный прокси-сервер (reverse proxy, реверс-прокси) служит для ретрансляции запросов из внешней сети к каким-либо серверам/сервисам внутренней сети (например веб-сервера, БД или файловые хранилища) и позволяет:

* обеспечить сокрытие структуры внутренней сети и подробностей о находящейся в ней сервисах;
* осуществлять балансировку нагрузки (load balancing) между экземплярами одного и того же сервиса или серверами с одинаковыми задачами;
* обеспечить зашифрованное (HTTPS) соединение между клиентом и любым сервисом, в таком случае SSL сессия создается между клиентом и прокси, а между прокси и сервисом во внутренней сети устанавливается незашифрованное HTTP соединение, если сервис поддерживает HTTPS то можно организовать зашифрованное соединение и во внутренней сети;
* организовать контроль доступа к сервисам (аутентификацию клиента), а также установить файрвол (брандмауэр).

## 1. Подготовка к работе

### 1.1 В `/router/docker-compose.yml` необходимо ввести доменное имя для дашборда Traefik, по которому он будет доступен из вне:
```yaml
labels:
      ...
      - "traefik.http.routers.traefik.rule=Host(`traefik.localhost`)"
      ...
```

### 1.2 Проверить права доступа к `/router/acme.json` они должны быть `600`:
```console
-rw------- 1 cvtk cvtk 3526 Apr  8 09:50 router/acme.json
```

### 1.3 Сгенерировать логин и пароль для доступа к дашборду
```console
htpasswd -nb admin pAsSwORd > router/users-credentials.example
mv router/users-credentials.example router/users-credentials
```

## 2. Запуск обратного прокси

```console
docker-compose up -d
docker-compose logs -f
```

Если всё было настроено правильно, то в логах не должно быть ошибок, а по адресу `https://traefik.localhost` будет доступен дашборд traefik.

## 3. Запуск тестового хоста

В директории `/router/test` содержится пример конфигурации хоста внутренней сети, на основе которого можно разрабатывать свои конфиги. Для запуска тестовой конфигурации достаточно отредактировать строчку в `/router/test/docker-compose.yml` и ввести своё доменное имя для тестового сайта:
```yaml
      labels:
        ...
        - "traefik.http.routers.test.rule=Host(`test.localhost`)"
        ...
```

После запуска Traefik потребуется некоторое время, чтобы автоматически получить сертификаты для тестового хоста, после чего он будет доступе по адресу `https://test.localhost`.